name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"* %s" > CHANGELOG.md
          else
            git log --pretty=format:"* %s" $PREVIOUS_TAG..HEAD > CHANGELOG.md
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          body: |
            ## Changelog
            ${{ steps.changelog.outputs.CHANGELOG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute SHA256 for Homebrew
        id: hash
        run: |
          FILENAME=$(ls dist/*.tar.gz)
          SHA=$(shasum -a 256 "$FILENAME" | awk '{print $1}')
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "file=$FILENAME" >> $GITHUB_OUTPUT

      - name: Clone Homebrew Tap
        run: |
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/ocolunga/homebrew-mct.git tap
          cd tap
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Update Formula
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          URL="https://github.com/ocolunga/mct/archive/refs/tags/v${VERSION}.tar.gz"
          SHA="${{ steps.hash.outputs.sha }}"

          FORMULA_FILE="tap/Formula/mct.rb"

          # Update version, URL, and sha256 in the formula
          sed -i "s|url \".*\"|url \"$URL\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"$SHA\"|" "$FORMULA_FILE"

      - name: Commit and Push Formula Update
        run: |
          cd tap
          git add Formula/mct.rb
          git commit -m "Update formula to v${GITHUB_REF#refs/tags/v}"
          git push
