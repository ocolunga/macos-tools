name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install build tool
        run: pip install build

      - name: 📦 Build sdist
        run: python -m build --sdist

      - name: 🔢 Compute SHA256
        id: hash
        run: |
          FILENAME=$(ls dist/*.tar.gz)
          SHA=$(shasum -a 256 "$FILENAME" | awk '{print $1}')
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "file=$FILENAME" >> $GITHUB_OUTPUT

      - name: ⬇️ Clone Homebrew Tap
        run: |
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/ocolunga/homebrew-mct.git tap
          cd tap
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: 📝 Update Formula
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          URL="https://github.com/ocolunga/mct/archive/refs/tags/v${VERSION}.tar.gz"
          SHA="${{ steps.hash.outputs.sha }}"

          FORMULA_FILE="tap/Formula/mct.rb"

          # Update version, URL, and sha256 in the formula
          sed -i "s|url \".*\"|url \"$URL\"|" "$FORMULA_FILE"
          sed -i "s|sha256 \".*\"|sha256 \"$SHA\"|" "$FORMULA_FILE"

          # Install Homebrew and set up the environment
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> $HOME/.bashrc
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          
          # Install dependencies
          sudo apt-get update
          sudo apt-get install -y build-essential
          brew developer on
          brew install gcc
          
          # Update python dependencies in the formula
          cd tap
          brew install --only-dependencies ./Formula/mct.rb || true
          brew update-python-resources --package-name=mct --exclude-packages="" ./Formula/mct.rb || true
          
          # Test installation from the formula
          brew install --build-from-source ./Formula/mct.rb
          
          # Verify the installation by checking the version
          mct --version
          
          git add Formula/mct.rb
          git commit -m "Update formula to v${VERSION}"
          git push https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/ocolunga/homebrew-mct.git main
